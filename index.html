<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WiFi setup</title>
  <style>
    body
    {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 30px;
      background-color: #121212;
      color: #FFFFFF;
    }
    h2
    {
      color: #FFFFFF;
    }
	img
    {
      max-width: 90%;
      height: auto;
      margin-bottom: 20px;
      border: 2px solid #444;
      border-radius: 8px;
    }
	
	/*label, select, input { display:block; width:100%; margin:8px 0; }*/
    select
	{
		position: relative;
		min-height: 40px;
		min-width: 250px;
		background: #1E1E1E;
		color: #fff;
		border: 1px solid #444;
		border-radius:8px;
		padding:8px;
	}
    input
	{
		min-height: 22px;
		min-width: 230px;
		position: relative;
		padding:8px;
		border-radius:8px;
		border:1px solid #444;
		background:#111;
		color:#fff;
	}
    button
	{
		position: relative;
		background-color: #1E1E1E;
		color: #FFFFFF;
		border: 1px solid #444;
        border-radius: 8px;
		padding: 10px 24px;
		font-size: 16px;
		margin-top:8px;
		min-width: 200px;
		cursor: pointer;
        transition: background-color 0.3s, border-color 0.3s;
	}
	  
      
      
      
      
      
      
	  
	  
	  
	  small { color:#aaa; }
    #msg { margin-top:8px; color:#9f9; word-break:break-all; white-space:pre-wrap; }
    #raw { margin-top:8px; color:#f99; font-size:12px; word-break:break-all; white-space:pre-wrap; }
	
	  footer
	  {
		margin-top: 40px;
		font-size: 12px;
		color: #AAAAAA;
	  }
	</style>
</head>
<body>
  <img src="Logo.bmp" alt="No image yet">
  <h2>WiFi Setup</h2>
  <p>Choose your own wifi network.</p>
  <br><br>
  <label for="ssid">Available networks</label><br><br>
  <select id="ssid"><option>Scanning...</option></select><br><br>

  <label for="pwd">Password</label><br><br>
  <input id="pwd" type="password" placeholder="WiFi password"><br><br><br><br>

  <button id="rescan">Rescan</button>
	<br>
  <button id="save">Save & Reboot</button><br>
  <button id="clear">Clear saved networks</button><br>

  <p id="msg"></p>
  <pre id="raw"></pre>
  <br><br><br><br>
	<footer>
    Anima Nails - 2026
  </footer>
  
	<script>
  // Feltöltjük a select-et a kapott listából
  function populateSelectFromList(list)
  {
    const sel = document.getElementById('ssid');
    sel.innerHTML = '';
    if (!list || list.length === 0)
    {
      const opt = document.createElement('option');
      opt.value = '';
      opt.text = 'No networks found';
      sel.appendChild(opt);
      document.getElementById('msg').innerText = 'No networks found';
      return;
    }
    list.forEach(function(item) {
      var opt = document.createElement('option');
      opt.value = item.ssid;
      opt.text = item.ssid + ' (' + item.rssi + ' dBm)' + (item.secure? ' [secure]':' [open]');
      sel.appendChild(opt);
    });
    document.getElementById('msg').innerText = 'Loaded cached scan: ' + list.length + ' networks';
  }

  function loadCachedNetworks()
  {
    document.getElementById('msg').innerText = 'Loading cached list...';
    fetch(location.origin + '/lastscan', { cache: 'no-store' })
      .then(function(resp) { return resp.text(); })
      .then(function(text) {
        document.getElementById('raw').innerText = text;
        try {
          var list = JSON.parse(text);
        } catch (e) {
          console.error('Invalid JSON from /lastscan:', e);
          document.getElementById('msg').innerText = 'No cached data';
          return;
        }
        populateSelectFromList(list);
      })
      .catch(function(e) {
        console.error('Failed to fetch /lastscan:', e);
        document.getElementById('msg').innerText = 'Failed to load cached list';
      });
  }

  function doScanWithWarning()
  {
    if (!confirm('Scan will stop and restart the access point briefly. Your phone will disconnect and you will need to reconnect to the AP. Proceed?'))
    {
      return;
    }

    document.getElementById('msg').innerText = 'Starting scan... (you will be disconnected briefly)';
    document.getElementById('raw').innerText = '';
    document.getElementById('ssid').innerHTML = '<option>Scanning...</option>';

    const url = location.origin + '/scan';
    fetch(url, { cache: 'no-store' })
      .then(function(resp) { return resp.text(); })
      .then(function(text) {
        document.getElementById('raw').innerText = text;
        try {
          var list = JSON.parse(text);
          populateSelectFromList(list);
        } catch (e) {
          console.warn('Scan returned invalid JSON (or disconnected):', e);
        }
        waitForAPAndReload();
      })
      .catch(function(e) {
        console.error('scan request failed (probably disconnected):', e);
        document.getElementById('msg').innerText = 'Scan started — waiting for device to restore AP...';
        waitForAPAndReload();
      });
  }

  function waitForAPAndReload()
  {
    const pingUrl = location.origin + '/ping';
    document.getElementById('msg').innerText = 'Waiting for device to restore AP...';
    document.getElementById('raw').innerText = 'Waiting for AP...';
    const interval = setInterval(function()
    {
      fetch(pingUrl, { cache: 'no-store' })
        .then(function(r) {
          if (r.status === 200)
          {
            clearInterval(interval);
            setTimeout(function() { loadCachedNetworks(); }, 800);
          }
        })
        .catch(function() {
          // maradunk várakozóban
        });
    }, 1000);
  }

  // Események
  document.getElementById('rescan').onclick = function() { doScanWithWarning(); };

  // --- SAVE handler: POST form adatokkal a /save végpontnak ---
  document.getElementById('save').onclick = function()
  {
    const ssid = document.getElementById('ssid').value;
    const pwd = document.getElementById('pwd').value;
    if (!ssid)
    {
      document.getElementById('msg').innerText = 'Please choose an SSID.';
      return;
    }
    var form = new FormData();
    form.append('ssid', ssid);
    form.append('password', pwd);
    document.getElementById('msg').innerText = 'Saving credentials...';
    fetch(location.origin + '/save', { method: 'POST', body: form })
      .then(function(r) { return r.text(); })
      .then(function(t) {
        document.getElementById('raw').innerText = t;
        document.getElementById('msg').innerText = 'Saved. Device will reboot.';
      })
      .catch(function(e) {
        console.error('Save failed:', e);
        document.getElementById('msg').innerText = 'Save failed: ' + e;
      });
  };

  // Clear saved networks: POST /clear (törli a /wifi.txt fájlt és újraindít)
  document.getElementById('clear').onclick = function()
  {
    if (!confirm('Really clear all saved networks? This will remove saved SSID/password and reboot the device.'))
    {
      return;
    }

    document.getElementById('msg').innerText = 'Clearing saved networks and rebooting...';
    fetch(location.origin + '/clear', { method: 'POST' })
      .then(function(resp) { return resp.text(); })
      .then(function(text) { document.getElementById('raw').innerText = text; })
      .catch(function(e) {
        console.error('Clear request failed:', e);
        document.getElementById('msg').innerText = 'Clear request failed: ' + e;
      });
  };

  window.addEventListener('load', function() { setTimeout(loadCachedNetworks, 300); });
  </script>

</body>
</html>
